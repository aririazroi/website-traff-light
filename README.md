# Traffic Light News - Misleading Content Detection

A news aggregation system that scores articles for title-content misalignment and displays them with traffic light indicators (green/yellow/red) to help users identify potentially misleading headlines.

## Project Overview

This project consists of three main components:

1. **Website** - A news display interface showing articles with traffic light indicators
2. **News Pipeline (App)** - Batch pipeline for a future mobile/web app (outputs JSON)
3. **News Pipeline (Web)** - Batch pipeline for the website (outputs `articles.js` with stratified sampling)

```
v4/
â”œâ”€â”€ index.html              # Website entry point
â”œâ”€â”€ script.js               # Website logic + tracking
â”œâ”€â”€ styles.css              # Website styles
â”œâ”€â”€ articles.js             # Article data (generated or static)
â”œâ”€â”€ google-apps-script.js   # Google Sheets tracking webhook
â”œâ”€â”€ news_pipeline/          # Pipeline for future app
â””â”€â”€ news_pipeline_web/      # Pipeline for website
```

---

## Website

### Features

- Displays news articles with **traffic light indicators**:
  - ðŸŸ¢ **Green**: Title aligns well with content (score 0-33)
  - ðŸŸ¡ **Yellow**: Some misalignment detected (score 34-66)
  - ðŸ”´ **Red**: Significant misalignment / potentially misleading (score 67-100)
- Article modal with full content view
- User interaction tracking via Google Sheets
- Participant ID support (`?pid=...` URL parameter)

### Running the Website

```bash
# Install dependencies
npm install

# Start development server
npm run dev
```

The website reads from `articles.js` which can be:
- Static (hand-written articles for testing)
- Generated by `news_pipeline_web` (live GNews articles)

### Tracking System

User interactions are tracked and sent to Google Sheets:
- Article clicks
- Traffic light hovers
- Modal view duration
- Session start/end

See `GOOGLE_SHEETS_SETUP.md` for setup instructions.

---

## News Pipelines

Both pipelines share the same core flow:

```
GNews API â†’ Fetch Articles â†’ NLP Scoring â†’ Traffic Light Mapping â†’ Output
```

### Pipeline Comparison

| Feature | `news_pipeline/` (App) | `news_pipeline_web/` (Website) |
|---------|------------------------|--------------------------------|
| Purpose | Future mobile/web app | Current website |
| Output | `articles.json` | `articles.js` |
| Sampling | All articles | 3 per color bin (9 total) |
| Format | JSON with metadata | JavaScript for direct inclusion |

---

## News Pipeline (App Version)

Located in `news_pipeline/`. Outputs all scored articles as JSON.

### Quick Start

```bash
cd news_pipeline

# Create virtual environment
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# Run
GNEWS_API_KEY=your_key python3 -m app.main
```

### Output

Writes to `output/articles.json`:

```json
{
  "lastUpdated": "2026-01-29T12:00:00+00:00",
  "articles": [
    {
      "id": "abc123",
      "title": "Article Title",
      "summary": "Description...",
      "content": "Full content...",
      "url": "https://...",
      "image": "https://...",
      "publishedAt": "2026-01-29T10:00:00Z",
      "source": { "id": "...", "name": "...", "url": "...", "country": "..." },
      "misleadingScore": 45,
      "trafficLightStatus": "yellow"
    }
  ]
}
```

---

## News Pipeline (Website Version)

Located in `news_pipeline_web/`. Outputs sampled articles as JavaScript.

### Quick Start

```bash
cd news_pipeline_web

# Create virtual environment
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# Run (generates ../articles.js)
GNEWS_API_KEY=your_key \
MAX_RESULTS=30 \
python3 -m app.main --per-bin 3 --out ../articles.js
```

### Stratified Sampling

The website pipeline implements **stratified sampling** to ensure balanced representation:

1. Fetches N articles (e.g., 30)
2. Scores all articles
3. Bins them by color (green/yellow/red)
4. Randomly samples 3 from each bin
5. Outputs 9 articles total (3 green + 3 yellow + 3 red)

This ensures users see a mix of trustworthy and potentially misleading articles for comparison.

### CLI Options

```bash
python3 -m app.main [OPTIONS]

Options:
  --out PATH      Output file path (default: ../articles.js)
  --per-bin N     Articles per color bin (default: 3)
  --format FMT    Output format: js or json (default: js)
```

### Output

Writes to `articles.js`:

```javascript
const articles = [
    {
        id: 1,
        title: "Article Title",
        summary: "Brief description...",
        category: "Source Name â€¢ Country",
        image: "https://...",
        trafficLightStatus: "green",
        misleadingScore: 23,
        content: "<p>HTML formatted content...</p>",
        url: "https://...",
        publishedAt: "2026-01-29T10:00:00Z"
    },
    // ... 8 more articles
];
```

---

## Configuration

Both pipelines are configured via environment variables:

### Required

| Variable | Description |
|----------|-------------|
| `GNEWS_API_KEY` | Your GNews API key ([get one here](https://gnews.io)) |

### Optional

| Variable | Default | Description |
|----------|---------|-------------|
| `GNEWS_ENDPOINT` | `https://gnews.io/api/v4/search` | GNews API endpoint |
| `QUERY` | `news` | Search query ([syntax docs](https://docs.gnews.io/endpoints/search-endpoint#query-syntax)) |
| `LANG` | `en` | Language code (en, fr, de, es, etc.) |
| `COUNTRY` | *(any)* | Country code (us, gb, fr, etc.) - leave empty for any |
| `MAX_RESULTS` | `10` / `30` | Number of articles to fetch |
| `GREEN_MAX` | `33` | Maximum score for green traffic light |
| `YELLOW_MAX` | `66` | Maximum score for yellow traffic light |
| `SCORER_MODULE` | `scorer` | Python module containing the scorer function |
| `OUTPUT_PATH` | varies | Output file path |

### Traffic Light Thresholds

The score-to-color mapping is configurable:

```
Score 0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ GREEN_MAX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ YELLOW_MAX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 100
        [  GREEN  ]           [ YELLOW ]            [  RED  ]
```

Default: `0-33 = green`, `34-66 = yellow`, `67-100 = red`

To be stricter (flag more articles):
```bash
export GREEN_MAX=25
export YELLOW_MAX=50
```

---

## NLP Scorer Integration

Both pipelines expect a Python module with a `score` function:

```python
def score(title: str, content: str) -> int:
    """
    Compute misalignment between article title and content.
    
    Args:
        title: The article headline
        content: The article body text
        
    Returns:
        Integer score from 0 (well-aligned) to 100 (highly misleading)
    """
    # Your NLP model logic here
    return computed_score
```

### Setup

1. Replace `scorer.py` in the pipeline folder with your implementation
2. Or set `SCORER_MODULE=your_package.your_module` if your scorer is elsewhere

### Placeholder

Both pipelines include a placeholder `scorer.py` that returns dummy scores. Replace this with your actual NLP model before production use.

---

## Deployment

### Website Only (Static)

```bash
# Build for production
npm run build

# Deploy dist/ folder to any static host (Netlify, Vercel, GitHub Pages, etc.)
```

### Website + Pipeline (Automated)

For automated article updates:

1. **Deploy pipeline** to a server/cloud function
2. **Schedule** to run periodically (e.g., every 30 minutes)
3. **Output** `articles.js` to your static host or CDN

#### Google Cloud Run Jobs

```bash
cd news_pipeline_web

# Build and push
gcloud builds submit --tag gcr.io/PROJECT/news-pipeline-web

# Create scheduled job
gcloud run jobs create news-pipeline-web \
  --image gcr.io/PROJECT/news-pipeline-web \
  --set-env-vars GNEWS_API_KEY=your_key

# Schedule every 30 minutes
gcloud scheduler jobs create http news-pipeline-scheduler \
  --schedule "*/30 * * * *" \
  --uri "https://REGION-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/PROJECT/jobs/news-pipeline-web:run" \
  --http-method POST
```

#### Docker (Local/Server)

```bash
cd news_pipeline_web
docker build -t news-pipeline-web .
docker run --rm \
  -e GNEWS_API_KEY=your_key \
  -v $(pwd)/../articles.js:/app/output/articles.js \
  news-pipeline-web
```

---

## Project Structure

```
v4/
â”œâ”€â”€ index.html                    # Website HTML
â”œâ”€â”€ script.js                     # Website JS (rendering, tracking, modal)
â”œâ”€â”€ styles.css                    # Website styles
â”œâ”€â”€ articles.js                   # Article data (static or generated)
â”œâ”€â”€ vite.config.js                # Vite bundler config
â”œâ”€â”€ package.json                  # Node dependencies
â”‚
â”œâ”€â”€ google-apps-script.js         # Google Sheets webhook code
â”œâ”€â”€ GOOGLE_SHEETS_SETUP.md        # Tracking setup guide
â”‚
â”œâ”€â”€ news_pipeline/                # Pipeline for future app
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py             # Environment config
â”‚   â”‚   â”œâ”€â”€ gnews_client.py       # GNews API client
â”‚   â”‚   â”œâ”€â”€ main.py               # CLI entrypoint
â”‚   â”‚   â”œâ”€â”€ mapping.py            # Score â†’ color
â”‚   â”‚   â”œâ”€â”€ models.py             # Data models
â”‚   â”‚   â””â”€â”€ scoring.py            # Scorer adapter
â”‚   â”œâ”€â”€ output/
â”‚   â”‚   â””â”€â”€ articles.json         # Generated output
â”‚   â”œâ”€â”€ scorer.py                 # YOUR NLP scorer
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ README.md
â”‚
â””â”€â”€ news_pipeline_web/            # Pipeline for website
    â”œâ”€â”€ app/
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ config.py
    â”‚   â”œâ”€â”€ gnews_client.py       # + HTML formatting
    â”‚   â”œâ”€â”€ main.py               # + sampling + JS output
    â”‚   â”œâ”€â”€ mapping.py
    â”‚   â”œâ”€â”€ models.py             # Website-compatible schema
    â”‚   â”œâ”€â”€ sampling.py           # Stratified sampling
    â”‚   â””â”€â”€ scoring.py
    â”œâ”€â”€ output/
    â”œâ”€â”€ scorer.py                 # YOUR NLP scorer
    â”œâ”€â”€ requirements.txt
    â”œâ”€â”€ Dockerfile
    â””â”€â”€ README.md
```

---

## GNews API Reference

- **Endpoint**: `https://gnews.io/api/v4/search`
- **Docs**: https://docs.gnews.io/endpoints/search-endpoint
- **Rate limits**: Depends on plan (free plan has 12-hour delay)

### Query Examples

```bash
# Latest tech news in English
QUERY="technology" LANG="en" MAX_RESULTS=30

# US politics
QUERY="politics" LANG="en" COUNTRY="us" MAX_RESULTS=30

# Specific topic with operators
QUERY="climate AND (policy OR legislation)" LANG="en" MAX_RESULTS=30
```

---

## Troubleshooting

### "GNEWS_API_KEY environment variable is required"
Set the environment variable before running:
```bash
export GNEWS_API_KEY=your_key_here
```

### "Module 'scorer' has no attribute 'score'"
Your scorer module must expose a `score(title, content) -> int` function.

### Not enough articles in a color bin
Increase `MAX_RESULTS` to fetch more articles, giving better distribution across bins.

### Website shows old articles
Re-run the pipeline to regenerate `articles.js`:
```bash
cd news_pipeline_web
GNEWS_API_KEY=your_key python3 -m app.main --out ../articles.js
```

---

## License

[Add your license here]
